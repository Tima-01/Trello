<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Вход</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">

</head>
<body>
<div class="error-modal" id="errorModal">
    <div class="error-modal-content">
        <h3>Ошибка</h3>
        <p id="modalErrorMessage"></p>
        <button class="error-modal-close" onclick="closeErrorModal()">Закрыть</button>
    </div>
</div>

<form id="loginForm" th:action="@{/login}" method="post" onsubmit="return validateForm()">
    <h2>Вход</h2>

    <div class="error-message" id="usernameError">
        Имя пользователя должно содержать от 3 до 20 символов
    </div>
    <input type="text" name="username" id="username"
           placeholder="Имя пользователя" required
           th:value="${username}">

    <div class="error-message" id="passwordError">
        Пароль должен содержать не менее 6 символов
    </div>
    <input type="password" name="password" id="password" placeholder="Пароль" required>

    <button type="submit">Войти</button>

    <!-- Скрытое поле для серверного сообщения об ошибке -->
    <input type="hidden" id="serverMessage" th:value="${message}">

    <p style="text-align: center; margin-top: 10px;">
        Нет аккаунта? <a th:href="@{/register}">Регистрация</a>
    </p>
</form>

<script>
    function showErrorModal(message) {
        document.getElementById('modalErrorMessage').textContent = message;
        document.getElementById('errorModal').style.display = 'flex';
    }

    function closeErrorModal() {
        document.getElementById('errorModal').style.display = 'none';
    }

    function validateForm() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        let isValid = true;
        localStorage.setItem('login-username', username);
        // Валидация имени пользователя
        if (username.length < 3 || username.length > 20) {
            document.getElementById('usernameError').style.display = 'block';
            document.getElementById('username').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('usernameError').style.display = 'none';
            document.getElementById('username').classList.remove('input-error');
        }

        // Валидация пароля
        if (password.length < 6) {
            document.getElementById('passwordError').style.display = 'block';
            document.getElementById('password').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('password').classList.remove('input-error');
        }

        if (!isValid) {
            showErrorModal('Пожалуйста, исправьте ошибки в форме');
            return false;
        }

        return isValid;
    }

    // Проверяем серверное сообщение при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const errorParam = urlParams.get('error');
        const savedUsername = localStorage.getItem('login-username');
        if (savedUsername && !document.getElementById('username').value) {
            document.getElementById('username').value = savedUsername;
        }
        if (errorParam) {
            showErrorModal('Неверное имя пользователя или пароль');
            document.getElementById('username').classList.add('input-error');
            document.getElementById('password').classList.add('input-error');

            // Очищаем параметр error из URL без перезагрузки страницы
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Проверяем серверное сообщение
        const serverMessage = document.getElementById('serverMessage')?.value;
        if (serverMessage && serverMessage.trim() !== '') {
            showErrorModal(serverMessage);
        }
    });
    document.getElementById('username').addEventListener('input', function() {
        localStorage.setItem('login-username', this.value.trim());
    });
</script>
</body>
</html>